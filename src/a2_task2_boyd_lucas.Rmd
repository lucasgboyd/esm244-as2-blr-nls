---
title: "Lizards Parameter Estimation (Task 2)"
author: "Lucas Boyd"
date: "2/1/2022"
output: 
  html_document:
    code_folding: hide
---

## Overview

The following report examines lizard pitfall trap data in the Jornada Basin LTER site from 1989-2006. Firs, non-linear least squares (NLS) is used to fit a model of lizard weight as a function of its snout-vent length across all 13 lizard species. Then, NLS is used again to fit a model to male western whiptail lizards. Finally, the species-specific and general models are compared to determine which one is more effective. 

**Data Citation:** Lightfoot, D. and W.G. Whitford. 2020. Lizard pitfall trap data from 11 NPP study locations at the Jornada Basin LTER site, 1989-2006 ver 37. Environmental Data Initiative. https://doi.org/10.6073/pasta/4a6e258fb49c31e222ecbbcfd128967f


## Setup 
```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
# attach packages
library(tidyverse)
library(broom)
library(purrr)
library(here)
library(janitor)
library(kableExtra)
library(modelr)
```

```{r}
# reading in the data
lizards <- read_csv(here("data", "lizard.csv")) %>% 
  clean_names() %>% 
  mutate(log_weight = log(weight)) %>% # log transforming the data - since we are using an exponential base equation
  mutate(log_length = log(sv_length)) %>% 
  drop_na()
```


```{r, include = FALSE}
# looking at the data 
ggplot(data = lizards, aes(x = sv_length, y = weight)) +
         geom_point()
# taking a quick peak at the log transformed data
ggplot(data = lizards, aes(x = log_length, y = log_weight)) +
         geom_point()
```
## Finding guess coefficients for use in NLS
The following equation was used as a starting point for the structure of the NLS model:
\[
W = a(SVL)^b
\]

```{r}
# running a linear regression on log transformed data to find coefficients
guess_model <- lm(log_weight ~ log_length, data = lizards)

tidy_guess <- tidy(guess_model) # tidy output of lm model

coef <- coefficients(guess_model) # pulling out coefficients for use in NLS
# estimate of coefficient b = 2.537 `r tidy_guess$estimate[2]`
# estmate of coefficent b = -8.475 `r tidy_guess$estimate[1]`

# storing a function of our model with coefficients
weight_function <- function(a, sv_length, b){
  weight = a*(sv_length)^b
  return(weight)
}
```

## Running NLS on all data

**Table 1** displays the results of NLS analysis on all lizards species, indicating the coefficients produced by the model, standard error, and signficance level. 
```{r}
# running the NLS
lizards_nls <- nls(weight ~ weight_function(a, sv_length, b),
                  data = lizards,
                  start = list(b = coef[2], # starting with the coefficients we estimated from the linear model
                               a = coef[1]))

nls_tidy <- tidy(lizards_nls) # tidy output of NLS model

# making a finalized table of the results of the NLS model
nls_tidy %>% 
  select(-statistic) %>% 
  mutate(p.value = case_when(
    p.value < 0.001 ~ "<0.001"
  )) %>% 
kable(col.names = c("Terms", "Coefficients", "Standard Error", "P.Value"),
      digits = 4) %>% 
  kable_minimal(full_width = FALSE)

```

```{r}
# predicting data based on our NLS model
lizards_augment <- augment(lizards_nls)

# plotting the predicted data to actual data
ggplot() +
  geom_point(data = lizards, aes(
             x = sv_length,
             y = weight, 
             color = sex)) +
  geom_line(data = lizards_augment, aes(
            x = sv_length,
            y = .fitted), 
            color = "red") +
  theme_minimal() +
  scale_color_manual(values = c("grey45", "black")) +
  theme(legend.position = c(0.2,0.7)) +
  labs( x = "SV Length (mm)", y = "Weight (g)")
  

# calculating RMSE
lizards_rmse <- rmse(lizards_nls, data = lizards)
```
**Fig. 1** shows


## Running NLS on Male western whiptail lizards

**Table 2** displays the results of NLS analysis on male western whiptail lizards, indicating the coefficients produced by the model, standard error, and signficance level. 
```{r}
# filtering for male whiptails
whips <- lizards %>% 
  filter(spp == "CNTI", sex == "M") 

# running linear regression on log transformed data to estimate starting coefficients
guess_whips <- lm(log_weight ~ log_length, data = whips)

tidy_whips_guess <- tidy(guess_model) # tidy output of guess model

whips_coef <- coefficients(guess_whips) # pulling out the coefficients for use in NLS

whips_nls <- nls(weight ~ weight_function(a, sv_length, b), # running NLS on male western whiptails
                  data = whips,
                  start = list(b = whips_coef[2], # starting from our guess coefficients
                               a = whips_coef[1]))

whips_nls_tidy <- tidy(whips_nls) # tidy output of model

# finalized table of NLS model
whips_nls_tidy %>% 
  select(-statistic) %>% 
  mutate(p.value = case_when(
    p.value < 0.001 ~ "<0.001",
    p.value > 0.001 ~ as.character(round(p.value, 3)))) %>% 
kable(col.names = c("Terms", "Coefficients", "Standard Error", "P Value"),
      digits = 4) %>% 
  kable_minimal(full_width = FALSE)
```

```{r}
# predicting data based on model
whips_augment <- augment(whips_nls)

# visualizing fitted model against actual data
ggplot() +
  geom_point(data = whips, aes(
             x = sv_length,
             y = weight)) +
  geom_line(data = whips_augment, aes(
            x = sv_length,
            y = .fitted),
            color = "red") +
  theme_minimal() +
  labs( x = "SV Length (mm)", y = "Weight (g)")

# calculating RMSE
whips_rmse <- rmse(whips_nls, data = whips)
```

**Fig. 2** shows 

Final model
\[
W = a(SVL)^b
\]